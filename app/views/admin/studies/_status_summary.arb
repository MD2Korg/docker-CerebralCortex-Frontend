panel title do

  @query = Hash[
      Datapoint.find_by_sql('
    SELECT
      max(ts) AS ts,
      participant_id
    FROM (
           SELECT
             datastream_id,
             ts,
             participant_id
           FROM (
                  SELECT
                    datastream_id,
                    max(timestamp) AS ts
                  FROM datapoints
                  GROUP BY datastream_id
                ) e1
             JOIN LATERAL (
                  SELECT
                    id,
                    participant_id
                  FROM datastreams
                  WHERE e1.datastream_id = id
                  ) e2 ON TRUE
         ) e3
    GROUP BY e3.participant_id'
      ).collect { |item| [item.participant_id, item.ts] }]

  table_for study.participants.order(:identifier) do
    column 'Identifier' do |i|
      link_to i.identifier, admin_participant_path(i.id)
    end

    column 'Data Last Received', :id do |i|

      if @query.has_key? i.id
        key = i.id + '_' + 'last-updated'
        $redis.set(key, @query[i.id].to_f)

        @query[i.id].utc
      end
    end

    column 'Day Start', :id do |i|
      begin
        ds = Datapoint.where(datastream_id: Datastream.where(participant_id: i, datasource_id: Datasource.where(datasourcetype: 'DAY_START')))
        if ds.present?
          Time.at(ds.last['sample'][0]/1000.0).utc
        end
      rescue
        'Data Error'
      end
    end
    column 'Day End', :id do |i|
      begin
        ds = Datapoint.where(datastream_id: Datastream.where(participant_id: i, datasource_id: Datasource.where(datasourcetype: 'DAY_END')))
        if ds.present?
          Time.at(ds.last['sample'][0]/1000.0).utc
        end
      rescue
        'Data Error'
      end
    end

    column 'Stress Episodes', :id do |i|
      ds = Datapoint.where(datastream_id: Datastream.where(participant_id: i, datasource_id: Datasource.where(datasourcetype: 'ORG_MD2K_CSTRESS_STRESS_EPISODE_CLASSIFICATION')))
      ds.count.to_s
    end

    column 'Total Payment', :id do |i|
      begin
        ds = Datapoint.where(datastream_id: Datastream.where(participant_id: i, datasource_id: Datasource.where(datasourcetype: 'INCENTIVE')))
        if ds.present?
          total_payment = ds.where("sample -> 0 ? 'totalIncentive'")
          total_payment.last['sample'][0]['totalIncentive'].to_s

        end
      rescue
        'Data Error'
      end
    end

  end
end
